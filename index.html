<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音に合わせて当ててみましょう</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
        }

        h1 {
            color: #333;
        }

        /* --- スタート画面 --- */
        #start-screen {
            text-align: center;
        }

        #last-score {
            font-size: 1.5rem;
            color: #333;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #mode-selection {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .start-button {
            font-size: 1.2rem;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #start-button-sound {
            background-color: #007bff;
        }
        #start-button-sound:hover {
            background-color: #0056b3;
        }
        #start-button-silent {
            background-color: #28a745;
        }
        #start-button-silent:hover {
            background-color: #1e7e34;
        }


        /* --- クイズ画面 --- */
        #quiz-screen {
            width: 90%;
            max-width: 800px;
        }
        
        #quiz-title {
            text-align: center;
            color: #555;
            font-size: 1.8rem;
        }

        #timer {
            font-size: 3rem;
            font-weight: bold;
            color: #d9534f;
            text-align: center;
            margin-bottom: 20px;
        }

        /* ★追加：読み込み中スピナー */
        #loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border: 5px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        video {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        video:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
        }

        #result {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        /* --- ユーティリティクラス --- */
        .hidden {
            display: none;
        }

        .correct {
            color: #28a745;
            background-color: #e6f7ec;
            border: 2px solid #28a745;
        }

        .incorrect {
            color: #dc3545;
            background-color: #fbebee;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>

    <h1>音に合わせて当ててみましょう</h1>

    <div id="start-screen">
        <h2>モードを選んでください</h2>
        <p id="last-score" class="hidden"></p>
        
        <div id="mode-selection">
            <button id="start-button-sound" class="start-button">金星の真島茂樹モード</button>
            <button id="start-button-silent" class="start-button">金星の真島茂樹どもモード</button>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <h2 id="quiz-title"></h2>
        
        <div id="timer">10</div>
        
        <div id="loading-spinner"></div>
        
        <div id="video-grid" class="hidden"> <video id="v0" loop playsinline></video>
            <video id="v1" loop playsinline></video>
            <video id="v2" loop playsinline></video>
            <video id="v3" loop playsinline></video>
        </div>
        <div id="result" class="hidden"></div>
    </div>

    <script>
        // --- 設定 ---
        const TIME_LIMIT = 10;
        const RESULT_DELAY = 1500; 

        // 使用する動画のリスト
        const videoSources = [
            "Dance to the rhythm of the Dance of Venus.mp4",
            "Let's dance to the rhythm of Venus' samba (JapaneseDub).mp4",
            "いい音が鳴ると体がサーフィンしちゃうんですよ.mp4",
            "それでは一緒に踊ってみましょう.mp4",
            "ターボビクスの組み合わせとってもいいでしょ？.mp4",
            "ダイナミックに踊ってみましょう.mp4",
            "マジーのダンスと言えばお馴染みのアレ.mp4",
            "ラテンのリズムで元気よく踊るマンボバージョン.mp4",
            "リズムに合わせてさあ踊ろう.mp4",
            "勇気を出して踊ってみましょう.mp4",
            "天保山でマジーと踊ろう.mp4",
            "家族みんなで踊ってくださいね.mp4",
            "後はゴージャスに踊ってみましょう.mp4",
            "感動する勇気を出して踊ってみましょう.mp4",
            "真島先生も一緒に踊ります.mp4",
            "私と一緒にターボビクス踊りましょうね.mp4",
            "腰元ダンサーに踊って頂きましょう.mp4",
            "音でいってみましょう.mp4",
            "音に合わしていってみましょう.mp4",
            "音に合わしていってみましょうね.mp4",
            "音に合わせていってみましょう.mp4",
            "音に合わせて元気よく.mp4",
            "音に合わせて踊ってみましょう.mp4",
            "音楽と一緒に踊ってみましょう.mp4",
            "音楽に合わせていってみましょう.mp4",
            "音楽に合わせてやってみましょう.mp4",
            "音楽に合わせてやってみましょう2.mp4",
            "音楽に合わせてやってみましょうね.mp4",
            "音楽に合わせて踊ってみましょう.mp4",
            "頭から通して踊ってみましょう.mp4"
        ];

        // --- DOM要素の取得 ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const timerEl = document.getElementById('timer');
        const resultEl = document.getElementById('result');
        const videos = document.querySelectorAll('#video-grid video');
        const lastScoreEl = document.getElementById('last-score');
        
        const startButtonSound = document.getElementById('start-button-sound');
        const startButtonSilent = document.getElementById('start-button-silent');
        const quizTitleEl = document.getElementById('quiz-title');

        // ★追加：新しいDOM要素
        const loadingSpinner = document.getElementById('loading-spinner');
        const videoGrid = document.getElementById('video-grid');

        // --- グローバル変数 ---
        let timerInterval = null;
        let timeLeft = TIME_LIMIT;
        let consecutiveWins = 0; 
        let currentQuizMode = 'findSound';

        // --- イベントリスナー ---
        document.addEventListener('DOMContentLoaded', preloadVideos);
        
        startButtonSound.addEventListener('click', () => startGame('findSound'));
        startButtonSilent.addEventListener('click', () => startGame('findSilent'));

        // --- 関数 ---

        /**
         * 動画のメタデータを先行読み込みする
         */
        function preloadVideos() {
            console.log('Preloading video metadata...');
            videoSources.forEach(src => {
                const video = document.createElement('video');
                video.src = src;
                video.preload = 'metadata';
            });
        }

        /**
         * クイズモードを指定して開始する
         */
        function startGame(mode) {
            currentQuizMode = mode; 
            
            if (currentQuizMode === 'findSound') {
                quizTitleEl.textContent = '音に合わせて(いる動画を)当ててみましょう';
            } else {
                quizTitleEl.textContent = '音に合わせて(いない動画を)当ててみましょう';
            }
            
            lastScoreEl.classList.add('hidden'); 
            
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            setupQuiz();
        }

        /**
         * ★変更：非同期(async)関数に変更し、読み込み待機ロジックを追加
         */
        async function setupQuiz() {
            resultEl.classList.add('hidden');
            resultEl.textContent = '';
            
            timeLeft = TIME_LIMIT;
            timerEl.textContent = timeLeft;
            timerEl.style.color = '#d9534f'; 

            // ★変更：タイマーを一旦停止
            if (timerInterval) clearInterval(timerInterval);

            // ★変更：動画グリッドを隠し、スピナーを表示
            videoGrid.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            const correctIndex = Math.floor(Math.random() * 4);
            const selectedVideos = shuffleArray(videoSources).slice(0, 4);

            // ★変更：動画の読み込みを待つためのPromise配列
            const loadPromises = [];

            videos.forEach((video, index) => {
                video.src = selectedVideos[index];
                video.currentTime = 0; 

                if (currentQuizMode === 'findSound') {
                    video.muted = (index !== correctIndex);
                } else {
                    video.muted = (index === correctIndex);
                }
                
                video.removeEventListener('click', handleVideoClick);
                video.addEventListener('click', handleVideoClick);

                // ★変更：再生準備完了('canplay')を待つPromiseを作成
                const promise = new Promise((resolve, reject) => {
                    // 'canplay'イベントは、再生を開始できる最小限のデータが読み込まれたときに発火
                    video.addEventListener('canplay', resolve, { once: true });
                    video.addEventListener('error', reject, { once: true });
                });
                loadPromises.push(promise);
                
                // 読み込みを開始
                video.load();
            });

            try {
                // ★変更：4つの動画すべての再生準備が整うまで待つ
                await Promise.all(loadPromises);

                // ★変更：準備ができたらスピナーを隠し、動画を表示
                loadingSpinner.classList.add('hidden');
                videoGrid.classList.remove('hidden');

                // ★変更：一斉に再生開始
                videos.forEach(video => {
                    video.play().catch(e => {
                        console.warn("Autoplay failed:", e);
                    });
                });

                // ★変更：タイマーをここで開始
                timerInterval = setInterval(updateTimer, 1000);

            } catch (error) {
                // 動画の読み込みに失敗した場合
                console.error("動画の読み込みに失敗しました:", error);
                // スタート画面に戻る
                alert("動画の読み込みに失敗しました。スタート画面に戻ります。");
                cleanupAndNext(false); // 失敗扱い
            }
        }

        /**
         * タイマーを1秒進める
         */
        function updateTimer() {
            timeLeft--;
            timerEl.textContent = timeLeft;

            if (timeLeft <= 3) {
                timerEl.style.color = 'red';
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showResult(false, "時間切れ！");
                cleanupAndNext(false);
            }
        }

        /**
         * 動画がクリックされたときの処理
         */
        function handleVideoClick(event) {
            // ★変更：クリックされたらすぐにタイマーを停止
            clearInterval(timerInterval);

            let isCorrect;
            if (currentQuizMode === 'findSound') {
                isCorrect = !event.currentTarget.muted;
            } else {
                isCorrect = event.currentTarget.muted;
            }
            
            showResult(isCorrect);
            cleanupAndNext(isCorrect);
        }

        /**
         * 正解・不正解を表示する
         */
        function showResult(isCorrect, message = '') {
            resultEl.classList.remove('hidden', 'correct', 'incorrect');
            
            if (message) {
                resultEl.textContent = message;
                resultEl.classList.add('incorrect');
            } else if (isCorrect) {
                resultEl.textContent = '正解！';
                resultEl.classList.add('correct');
            } else {
                resultEl.textContent = '不正解...';
                resultEl.classList.add('incorrect');
            }
        }

        /**
         * ラウンド終了処理と次のアクションの分岐
         */
        function cleanupAndNext(wasCorrect) {
            // ★変更：タイマーが残っていても停止（念のため）
            clearInterval(timerInterval);
            
            videos.forEach(video => {
                video.pause();
                video.muted = true;
                video.removeEventListener('click', handleVideoClick);
            });

            if (wasCorrect) {
                consecutiveWins++;
                setTimeout(setupQuiz, RESULT_DELAY);
            } else {
                // 失敗時はスタート画面に戻る
                setTimeout(() => {
                    quizScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                    
                    lastScoreEl.textContent = `スコア: ${consecutiveWins} 点`;
                    lastScoreEl.classList.remove('hidden');
                    
                    consecutiveWins = 0; 
                }, RESULT_DELAY);
            }
        }

        /**
         * 配列をシャッフルする
         */
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

    </script>

</body>
</html>
