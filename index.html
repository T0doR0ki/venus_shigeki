<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音に合わせて当ててみましょう</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
        }

        h1 {
            color: #333;
        }

        #start-screen {
            text-align: center;
        }

        #last-score {
            font-size: 1.5rem;
            color: #333;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #mode-selection {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .start-button {
            font-size: 1.2rem;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #start-button-sound {
            background-color: #007bff;
        }
        #start-button-sound:hover {
            background-color: #0056b3;
        }
        
        #start-button-find-all-sound {
            background-color: #28a745;
        }
        #start-button-find-all-sound:hover {
            background-color: #1e7e34;
        }


        #quiz-screen {
            width: 90%;
            max-width: 800px;
        }
        
        #quiz-title {
            text-align: center;
            color: #555;
            font-size: 1.8rem;
        }

        #timer {
            font-size: 3rem;
            font-weight: bold;
            color: #d9534f;
            text-align: center;
            margin-bottom: 20px;
        }

        #loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border: 5px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        video {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease, opacity 0.3s ease;
        }

        video:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
        }

        #result {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        .hidden {
            display: none;
        }

        .correct {
            color: #28a745;
            background-color: #e6f7ec;
            border: 2px solid #28a745;
        }

        .incorrect {
            color: #dc3545;
            background-color: #fbebee;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>

    <h1>音に合わせて当ててみましょう</h1>

    <div id="start-screen">
        <h2>モードを選んでください</h2>
        <p id="last-score" class="hidden"></p>
        
        <div id="mode-selection">
            <button id="start-button-sound" class="start-button">金星の真島茂樹モード</button>
            <button id="start-button-find-all-sound" class="start-button">金星の真島茂樹どもモード</button>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <h2 id="quiz-title"></h2>
        
        <div id="timer">10</div>
        
        <div id="loading-spinner"></div>
        
        <div id="video-grid" class="hidden">
            <video id="v0" loop playsinline></video>
            <video id="v1" loop playsinline></video>
            <video id="v2" loop playsinline></video>
            <video id="v3" loop playsinline></video>
        </div>
        <div id="result" class="hidden"></div>
    </div>

    <script>
        // --- 設定と難易度調整 ---
        const BASE_TIME_LIMIT = 10;
        const MIN_TIME_LIMIT = 5;
        const TIME_REDUCTION_PER_WIN = 0.2;
        const SAME_UNIT_CHANCE_INCREASE = 0.05;
        const RESULT_DELAY = 1500; 

        // --- 動画ユニット ---
        const videoUnits = [
             // ユニット1 音に合わせて
            [
				"音に合わせて踊ってみましょう.mp4",
				"音楽に合わせていってみましょう.mp4",
				"後はゴージャスに踊ってみましょう.mp4",
				"腰元ダンサーに踊って頂きましょう.mp4"
            ],
            // ユニット2 へんなしげき
            [
        		"音楽に合わせてやってみましょう.mp4",
        		"音楽に合わせてやってみましょう2.mp4",
				"勇気を出して踊ってみましょう.mp4",
				"感動する勇気を出して踊ってみましょう.mp4",
				"Let's dance to the rhythm of Venus' samba (JapaneseDub).mp4"
            ],
            // ユニット3 たぼびしげき
            [
				"私と一緒にターボビクス踊りましょうね.mp4",
				"マジーのダンスと言えばお馴染みのアレ.mp4",
				"ターボビクスの組み合わせとってもいいでしょ？.mp4",
				"ラテンのリズムで元気よく踊るマンボバージョン.mp4"
            ],
            // ユニット4 以外しげき
            [
				"Dance to the rhythm of the Dance of Venus.mp4",
				"いい音が鳴ると体がサーフィンしちゃうんですよ.mp4",
				"天保山でマジーと踊ろう.mp4",
				"真島先生も一緒に踊ります.mp4",
				"リズムに合わせてさあ踊ろう.mp4",
				"それでは一緒に踊ってみましょう.mp4"
            ],
            // ユニット5 せてして
            [
				"音楽に合わせてやってみましょうね.mp4",
				"音に合わしていってみましょうね.mp4",
				"音に合わしていってみましょう.mp4",
        		"音に合わせていってみましょう.mp4"
            ],
            // ユニット6 トゥー
            [
				"頭から通して踊ってみましょう.mp4",
				"音楽と一緒に踊ってみましょう.mp4",
				"ダイナミックに踊ってみましょう.mp4",
				"音でいってみましょう.mp4",
				"音楽に合わせて踊ってみましょう.mp4"
            ],
            // ユニット7 色違いしげき
			[
				"ターボビクスを教えるから一緒にやりましょうね.mp4",
				"家族みんなで踊ってくださいね.mp4",
				"リズムに合わせって曲になります.mp4",
				"音に合わせて元気よく.mp4"
            ]
        ];

        // --- DOM要素の取得 ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const timerEl = document.getElementById('timer');
        const resultEl = document.getElementById('result');
        const videos = document.querySelectorAll('#video-grid video');
        const lastScoreEl = document.getElementById('last-score');
        const startButtonSound = document.getElementById('start-button-sound');
        const startButtonFindAllSound = document.getElementById('start-button-find-all-sound');
        const quizTitleEl = document.getElementById('quiz-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const videoGrid = document.getElementById('video-grid');

        // --- グローバル変数 ---
        let timerInterval = null;
        let timeLeft = BASE_TIME_LIMIT;
        let consecutiveWins = 0; 
        let currentQuizMode = 'findSound';
        let correctClicksNeeded = 0;
        let correctClicksMade = 0;

        // --- イベントリスナー ---
        document.addEventListener('DOMContentLoaded', preloadVideos);
        startButtonSound.addEventListener('click', () => startGame('findSound'));
        startButtonFindAllSound.addEventListener('click', () => startGame('findAllSound'));

        // --- 関数 ---
        
        function preloadVideos() {
            console.log('Preloading video metadata...');
            videoUnits.flat().forEach(src => {
                const video = document.createElement('video');
                video.src = src;
                video.preload = 'metadata';
            });
        }

        function startGame(mode) {
            currentQuizMode = mode; 
            
            if (currentQuizMode === 'findSound') {
                quizTitleEl.textContent = '音に合わせて(いる動画を)当ててみましょう';
            } else { // 'findAllSound'
                quizTitleEl.textContent = '音に合わせて(いる動画を3つ)当ててみましょう';
            }
            
            lastScoreEl.classList.add('hidden'); 
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            setupQuiz();
        }

        function selectMixedVideos() {
            const shuffledUnits = shuffleArray(videoUnits).slice(0, 4);
            return shuffledUnits.map(unit => {
                return unit[Math.floor(Math.random() * unit.length)];
            });
        }
        function selectSameUnitVideos() {
            const selectedUnit = videoUnits[Math.floor(Math.random() * videoUnits.length)];
            return shuffleArray(selectedUnit).slice(0, 4);
        }


        async function setupQuiz() {
            resultEl.classList.add('hidden');
            resultEl.textContent = '';
            
            timeLeft = Math.max(MIN_TIME_LIMIT, BASE_TIME_LIMIT - (consecutiveWins * TIME_REDUCTION_PER_WIN));
            timerEl.textContent = Math.ceil(timeLeft);
            timerEl.style.color = '#d9534f'; 

            if (timerInterval) clearInterval(timerInterval);

            videoGrid.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            let selectedVideos;
            const sameUnitChance = Math.min(1, consecutiveWins * SAME_UNIT_CHANCE_INCREASE);
            
            console.log(`連続成功: ${consecutiveWins}回 / 制限時間: ${timeLeft.toFixed(1)}秒 / 同一ユニット率: ${Math.round(sameUnitChance * 100)}%`);

            if (Math.random() < sameUnitChance) {
                console.log("出題タイプ: 同一ユニット");
                selectedVideos = selectSameUnitVideos();
            } else {
                console.log("出題タイプ: バラバラ");
                selectedVideos = selectMixedVideos();
            }

            const targetIndex = Math.floor(Math.random() * 4);
            const loadPromises = [];

            correctClicksNeeded = 3; 
            correctClicksMade = 0;

            videos.forEach((video, index) => {
                video.src = selectedVideos[index];
                video.currentTime = 0; 
                video.style.opacity = '1.0'; 
                video.dataset.isTarget = 'false';

                if (currentQuizMode === 'findSound') {
                    video.muted = (index !== targetIndex);
                    if (index === targetIndex) {
                        video.dataset.isTarget = 'true';
                    }
                } else { // 'findAllSound'
                    video.muted = (index === targetIndex); 
                    if (index === targetIndex) {
                        video.dataset.isTarget = 'true'; // target = 音なし動画
                    }
                }
                
                video.removeEventListener('click', handleVideoClick);
                video.addEventListener('click', handleVideoClick);

                const promise = new Promise((resolve, reject) => {
                    video.addEventListener('canplay', resolve, { once: true });
                    video.addEventListener('error', reject, { once: true });
                });
                loadPromises.push(promise);
                
                video.load();
            });

            try {
                await Promise.all(loadPromises);

                loadingSpinner.classList.add('hidden');
                videoGrid.classList.remove('hidden');

                videos.forEach(video => {
                    video.play().catch(e => {
                        console.warn("Autoplay failed:", e);
                    });
                });

                timerInterval = setInterval(updateTimer, 1000);

            } catch (error) {
                console.error("動画の読み込みに失敗しました:", error);
                alert("動画の読み込みに失敗しました。スタート画面に戻ります。");
                cleanupAndNext(false); 
            }
        }

        function updateTimer() {
            timeLeft -= 1;
            
            timerEl.textContent = Math.ceil(Math.max(0, timeLeft)); 

            if (timeLeft <= 3) {
                timerEl.style.color = 'red';
            }

            if (timeLeft < 0) { 
                clearInterval(timerInterval);
                showResult(false, "時間切れ！");
                cleanupAndNext(false);
            }
        }

        /**
         * ★変更：クリック処理をモードによって分岐
         */
        function handleVideoClick(event) {
            const clickedVideo = event.currentTarget;
            const isTarget = clickedVideo.dataset.isTarget === 'true';

            if (currentQuizMode === 'findSound') {
                // --- 「音ありを1つ当てる」モード ---
                clearInterval(timerInterval);
                const isCorrect = isTarget; // target = 音あり動画
                
                showResult(isCorrect); // ★変更：messageなしで呼び出す
                cleanupAndNext(isCorrect);

            } else {
                // --- 「音ありを3つ当てる」モード ---
                
                if (isTarget) {
                    // ★不正解：音なし(target)をクリックした
                    clearInterval(timerInterval);
                    showResult(false, "不正解...");
                    cleanupAndNext(false);
                
                } else {
                    // ☆正解：音あり(not target)をクリックした
                    
                    if (!clickedVideo.muted) { 
                        correctClicksMade++;
                        clickedVideo.muted = true;
                        // ★★★修正点★★★： 'video' -> 'clickedVideo'
                        clickedVideo.style.opacity = '0.4'; 
                    }

                    if (correctClicksMade === correctClicksNeeded) {
                        clearInterval(timerInterval);
                        showResult(true, "正解！"); // ★変更：messageありで呼び出す
                        cleanupAndNext(true);
                    }
                }
            }
        }

        /**
         * ★★★修正点★★★：ロジックを変更
         */
        function showResult(isCorrect, message = '') {
            resultEl.classList.remove('hidden', 'correct', 'incorrect');
            
            if (isCorrect) {
                // 正解の場合
                resultEl.textContent = message || '正解！'; // messageがあればそれ、なければデフォルト
                resultEl.classList.add('correct');
            } else {
                // 不正解の場合
                resultEl.textContent = message || '不正解...'; // messageがあればそれ、なければデフォルト
                resultEl.classList.add('incorrect');
            }
        }

        function cleanupAndNext(wasCorrect) {
            clearInterval(timerInterval);
            
            videos.forEach(video => {
                video.pause();
                video.muted = true;
                video.removeEventListener('click', handleVideoClick);
                video.style.opacity = '1.0';
            });

            if (wasCorrect) {
                consecutiveWins++;
                setTimeout(setupQuiz, RESULT_DELAY);
            } else {
                setTimeout(() => {
                    quizScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                    
                    lastScoreEl.textContent = `スコア: ${consecutiveWins} 点`;
                    lastScoreEl.classList.remove('hidden');
                    
                    consecutiveWins = 0; 
                }, RESULT_DELAY);
            }
        }

        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

    </script>

</body>
</html>
