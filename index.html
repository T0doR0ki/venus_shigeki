<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>音に合わせて当ててみましょう</title>
    <style>

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            min-height: 100vh;
            background-color: #f0f2f5;
            margin: 0;
        }

        h1 {
            color: #333;
        }

        #start-screen {
            text-align: center;
        }

        #last-score {
            font-size: 1.5rem;
            color: #333;
            font-weight: bold;
            margin-bottom: 20px;
        }

        #mode-selection {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }

        .start-button {
            font-size: 1.2rem;
            padding: 15px 30px;
            border-radius: 10px;
            border: none;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        #start-button-sound {
            background-color: #007bff;
        }
        #start-button-sound:hover {
            background-color: #0056b3;
        }
        #start-button-silent {
            background-color: #28a745;
        }
        #start-button-silent:hover {
            background-color: #1e7e34;
        }


        #quiz-screen {
            width: 90%;
            max-width: 800px;
        }
        
        #quiz-title {
            text-align: center;
            color: #555;
            font-size: 1.8rem;
        }

        #timer {
            font-size: 3rem;
            font-weight: bold;
            color: #d9534f;
            text-align: center;
            margin-bottom: 20px;
        }

        #loading-spinner {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #3498db;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #video-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            border: 5px solid #ccc;
            border-radius: 10px;
            padding: 15px;
            background-color: #fff;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        video {
            width: 100%;
            aspect-ratio: 16 / 9;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        video:hover {
            transform: scale(1.03);
            box-shadow: 0 0 15px rgba(0, 123, 255, 0.7);
        }

        #result {
            font-size: 2.5rem;
            font-weight: bold;
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
        }

        .hidden {
            display: none;
        }

        .correct {
            color: #28a745;
            background-color: #e6f7ec;
            border: 2px solid #28a745;
        }

        .incorrect {
            color: #dc3545;
            background-color: #fbebee;
            border: 2px solid #dc3545;
        }
    </style>
</head>
<body>

    <h1>音に合わせて当ててみましょう</h1>

    <div id="start-screen">
        <h2>モードを選んでください</h2>
        <p id="last-score" class="hidden"></p>
        
        <div id="mode-selection">
            <button id="start-button-sound" class="start-button">金星の真島茂樹モード</button>
            <button id="start-button-silent" class="start-button">金星の真島茂樹どもモード</button>
        </div>
    </div>

    <div id="quiz-screen" class="hidden">
        <h2 id="quiz-title"></h2>
        
        <div id="timer">10</div>
        
        <div id="loading-spinner"></div>
        
        <div id="video-grid" class="hidden">
            <video id="v0" loop playsinline></video>
            <video id="v1" loop playsinline></video>
            <video id="v2" loop playsinline></video>
            <video id="v3" loop playsinline></video>
        </div>
        <div id="result" class="hidden"></div>
    </div>

    <script>
        // --- ★変更：設定と難易度調整 ---
        const BASE_TIME_LIMIT = 15; // 基本の制限時間（秒）
        const MIN_TIME_LIMIT = 5;  // 最短の制限時間（秒）
        const TIME_REDUCTION_PER_WIN = 0.2; // 1回成功で減る秒数 (0.2秒)
        const SAME_UNIT_CHANCE_INCREASE = 0.05; // 1回成功で同一ユニット率が上がる確率 (5%)
        const RESULT_DELAY = 1500; 

        // ★変更：動画リストの構造を「ユニット」ごとの2次元配列に変更
        //
        // !!重要!!
        // 1. ユニット（[ ]）は4つ以上定義してください。
        // 2. 各ユニット（[ ]）の中には、動画URL（'...'）を4つ以上入れてください。
        //
        const videoUnits = [
            // ユニット1 音に合わせて
            [
		"音に合わせて踊ってみましょう.mp4",
		"音楽に合わせていってみましょう.mp4",
		"後はゴージャスに踊ってみましょう.mp4",
		"腰元ダンサーに踊って頂きましょう.mp4"
            ],
            // ユニット2 へんなしげき
            [
        "音楽に合わせてやってみましょう.mp4",
        "音楽に合わせてやってみましょう2.mp4",
                "勇気を出して踊ってみましょう.mp4",
		"感動する勇気を出して踊ってみましょう.mp4",
		"Let's dance to the rhythm of Venus' samba (JapaneseDub).mp4"
            ],
            // ユニット3 たぼびしげき
            [
		"私と一緒にターボビクス踊りましょうね.mp4",
		"マジーのダンスと言えばお馴染みのアレ.mp4",
		"ターボビクスの組み合わせとってもいいでしょ？.mp4",
		"ラテンのリズムで元気よく踊るマンボバージョン.mp4"
            ],
            // ユニット4 以外しげき
            [
		"Dance to the rhythm of the Dance of Venus.mp4",
		"いい音が鳴ると体がサーフィンしちゃうんですよ.mp4",
		"天保山でマジーと踊ろう.mp4",
		"真島先生も一緒に踊ります.mp4",
		"リズムに合わせてさあ踊ろう.mp4",
		"それでは一緒に踊ってみましょう.mp4"
            ],
            // ユニット5 せてして
            [
		"音楽に合わせてやってみましょうね.mp4",
		"音に合わしていってみましょうね.mp4",
		"音に合わしていってみましょう.mp4",
        "音に合わせていってみましょう.mp4"
            ],
            // ユニット6 トゥー
            [
		"頭から通して踊ってみましょう.mp4",
		"音楽と一緒に踊ってみましょう.mp4",
		"ダイナミックに踊ってみましょう.mp4",
		"音でいってみましょう.mp4",
		"音楽に合わせて踊ってみましょう.mp4"
            ],
            // ユニット7 色違いしげき            [
		"ターボビクスを教えるから一緒にやりましょうね.mp4",
		"家族みんなで踊ってくださいね.mp4",
		"リズムに合わせって曲になります.mp4",
		"音に合わせて元気よく.mp4"
            ]
		
        ];

        // --- DOM要素の取得 (変更なし) ---
        const startScreen = document.getElementById('start-screen');
        const quizScreen = document.getElementById('quiz-screen');
        const timerEl = document.getElementById('timer');
        const resultEl = document.getElementById('result');
        const videos = document.querySelectorAll('#video-grid video');
        const lastScoreEl = document.getElementById('last-score');
        const startButtonSound = document.getElementById('start-button-sound');
        const startButtonSilent = document.getElementById('start-button-silent');
        const quizTitleEl = document.getElementById('quiz-title');
        const loadingSpinner = document.getElementById('loading-spinner');
        const videoGrid = document.getElementById('video-grid');

        // --- グローバル変数 (変更なし) ---
        let timerInterval = null;
        let timeLeft = BASE_TIME_LIMIT; // ★変更：動的に変わるためletに
        let consecutiveWins = 0; 
        let currentQuizMode = 'findSound';

        // --- イベントリスナー (変更なし) ---
        document.addEventListener('DOMContentLoaded', preloadVideos);
        startButtonSound.addEventListener('click', () => startGame('findSound'));
        startButtonSilent.addEventListener('click', () => startGame('findSilent'));

        // --- 関数 ---

        /**
         * ★変更：2次元配列をフラット化してプリロード
         */
        function preloadVideos() {
            console.log('Preloading video metadata...');
            // .flat()で2次元配列を1次元配列に変換
            videoUnits.flat().forEach(src => {
                const video = document.createElement('video');
                video.src = src;
                video.preload = 'metadata';
            });
        }

        /**
         * クイズモードを指定して開始する (変更なし)
         */
        function startGame(mode) {
            currentQuizMode = mode; 
            
            if (currentQuizMode === 'findSound') {
                quizTitleEl.textContent = '音が出ている動画を当てろ！';
            } else {
                quizTitleEl.textContent = '音が出ていない動画を当てろ！';
            }
            
            lastScoreEl.classList.add('hidden'); 
            
            startScreen.classList.add('hidden');
            quizScreen.classList.remove('hidden');
            setupQuiz();
        }

        /**
         * ★変更：ヘルパー関数（バラバラ問題の動画4つを選択）
         */
        function selectMixedVideos() {
            // 4つの異なるユニットをランダムに選ぶ
            const shuffledUnits = shuffleArray(videoUnits).slice(0, 4);
            // 各ユニットからランダムに1つ動画を選ぶ
            return shuffledUnits.map(unit => {
                return unit[Math.floor(Math.random() * unit.length)];
            });
        }

        /**
         * ★変更：ヘルパー関数（同一ユニット問題の動画4つを選択）
         */
        function selectSameUnitVideos() {
            // 1つのユニットをランダムに選ぶ
            const selectedUnit = videoUnits[Math.floor(Math.random() * videoUnits.length)];
            // そのユニットから4つの異なる動画をランダムに選ぶ
            return shuffleArray(selectedUnit).slice(0, 4);
        }


        /**
         * ★変更：非同期(async)関数、難易度ロジックを追加
         */
        async function setupQuiz() {
            resultEl.classList.add('hidden');
            resultEl.textContent = '';
            
            // ★変更：制限時間を動的に計算
            timeLeft = Math.max(MIN_TIME_LIMIT, BASE_TIME_LIMIT - (consecutiveWins * TIME_REDUCTION_PER_WIN));
            timerEl.textContent = Math.ceil(timeLeft); // 整数で表示
            timerEl.style.color = '#d9534f'; 

            if (timerInterval) clearInterval(timerInterval);

            videoGrid.classList.add('hidden');
            loadingSpinner.classList.remove('hidden');

            // ★変更：難易度に応じて動画選択ロジックを分岐
            let selectedVideos;
            // 同一ユニットになる確率（最大100% = 1.0）
            const sameUnitChance = Math.min(1, consecutiveWins * SAME_UNIT_CHANCE_INCREASE);
            
            console.log(`連続成功: ${consecutiveWins}回 / 制限時間: ${timeLeft.toFixed(1)}秒 / 同一ユニット率: ${Math.round(sameUnitChance * 100)}%`);

            if (Math.random() < sameUnitChance) {
                // 同一ユニット問題
                console.log("出題タイプ: 同一ユニット");
                selectedVideos = selectSameUnitVideos();
            } else {
                // バラバラ問題
                console.log("出題タイプ: バラバラ");
                selectedVideos = selectMixedVideos();
            }

            // 正解のインデックスをランダムに決定
            const correctIndex = Math.floor(Math.random() * 4);
            const loadPromises = [];

            videos.forEach((video, index) => {
                // ★変更：選択された動画リスト(selectedVideos)から設定
                video.src = selectedVideos[index];
                video.currentTime = 0; 

                if (currentQuizMode === 'findSound') {
                    video.muted = (index !== correctIndex);
                } else {
                    video.muted = (index === correctIndex);
                }
                
                video.removeEventListener('click', handleVideoClick);
                video.addEventListener('click', handleVideoClick);

                const promise = new Promise((resolve, reject) => {
                    video.addEventListener('canplay', resolve, { once: true });
                    video.addEventListener('error', reject, { once: true });
                });
                loadPromises.push(promise);
                
                video.load();
            });

            try {
                await Promise.all(loadPromises);

                loadingSpinner.classList.add('hidden');
                videoGrid.classList.remove('hidden');

                videos.forEach(video => {
                    video.play().catch(e => {
                        console.warn("Autoplay failed:", e);
                    });
                });

                timerInterval = setInterval(updateTimer, 1000); // 1秒ごとにタイマー更新

            } catch (error) {
                console.error("動画の読み込みに失敗しました:", error);
                alert("動画の読み込みに失敗しました。スタート画面に戻ります。");
                cleanupAndNext(false); 
            }
        }

        /**
         * タイマーを1秒進める
         */
        function updateTimer() {
            // ★変更：timeLeftを1秒減らす
            timeLeft -= 1;
            
            timerEl.textContent = Math.ceil(timeLeft); // 整数で表示

            if (timeLeft <= 3) {
                timerEl.style.color = 'red';
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                showResult(false, "時間切れ！");
                cleanupAndNext(false);
            }
        }

        /**
         * 動画がクリックされたときの処理 (変更なし)
         */
        function handleVideoClick(event) {
            clearInterval(timerInterval);

            let isCorrect;
            if (currentQuizMode === 'findSound') {
                isCorrect = !event.currentTarget.muted;
            } else {
                isCorrect = event.currentTarget.muted;
            }
            
            showResult(isCorrect);
            cleanupAndNext(isCorrect);
        }

        /**
         * 正解・不正解を表示する (変更なし)
         */
        function showResult(isCorrect, message = '') {
            resultEl.classList.remove('hidden', 'correct', 'incorrect');
            
            if (message) {
                resultEl.textContent = message;
                resultEl.classList.add('incorrect');
            } else if (isCorrect) {
                resultEl.textContent = '正解！';
                resultEl.classList.add('correct');
            } else {
                resultEl.textContent = '不正解...';
                resultEl.classList.add('incorrect');
            }
        }

        /**
         * ラウンド終了処理と次のアクションの分岐 (変更なし)
         */
        function cleanupAndNext(wasCorrect) {
            clearInterval(timerInterval);
            
            videos.forEach(video => {
                video.pause();
                video.muted = true;
                video.removeEventListener('click', handleVideoClick);
            });

            if (wasCorrect) {
                consecutiveWins++;
                setTimeout(setupQuiz, RESULT_DELAY);
            } else {
                setTimeout(() => {
                    quizScreen.classList.add('hidden');
                    startScreen.classList.remove('hidden');
                    
                    lastScoreEl.textContent = `前回の連続成功: ${consecutiveWins} 回`;
                    lastScoreEl.classList.remove('hidden');
                    
                    consecutiveWins = 0; 
                }, RESULT_DELAY);
            }
        }

        /**
         * ★変更：配列シャッフル関数 (グローバルスコープに移動)
         */
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

    </script>

</body>
</html>
